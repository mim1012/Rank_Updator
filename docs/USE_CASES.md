# Use Case Document - Turafic 시스템

**버전**: 1.0
**작성일**: 2025-12-29
**프로젝트**: Turafic (네이버/쿠팡 순위 최적화 AI 시스템)

---

## 1. 개요

이 문서는 Turafic 시스템의 주요 사용 시나리오를 정의합니다. 각 Use Case는 사용자 또는 시스템이 수행하는 핵심 작업 흐름을 설명합니다.

---

## 2. 액터 정의

### 2.1 주요 액터

| 액터 | 설명 | 유형 |
|-----|------|------|
| **운영자** | 시스템을 관리하는 관리자 | 인간 |
| **판매자** | 순위 모니터링을 의뢰하는 쇼핑몰 판매자 | 인간 |
| **AI Agent** | 자율적으로 작업을 수행하는 AI 에이전트 | 시스템 |
| **Android Bot** | 순위 체크를 실행하는 모바일 봇 | 시스템 |
| **Zero API** | 외부 키워드/순위 데이터 제공 서버 | 외부 시스템 |

### 2.2 AI Agent 세부

| Agent | 역할 |
|-------|------|
| **Orchestrator** | 전체 시스템 조율 |
| **Variable Agent** | 변수 조합 최적화 |
| **Bot Agent** | 봇 네트워크 관리 |
| **Campaign Agent** | 캠페인 실행 제어 |
| **Analysis Agent** | 순위 데이터 분석 |

---

## 3. Use Case 목록

### 3.1 캠페인 관리

| UC ID | Use Case | 액터 |
|-------|---------|------|
| UC-CAM-01 | 캠페인 생성 | 운영자 |
| UC-CAM-02 | 캠페인 시작/중지 | 운영자, Campaign Agent |
| UC-CAM-03 | 캠페인 상태 조회 | 운영자 |
| UC-CAM-04 | 캠페인 성과 분석 | 운영자, Analysis Agent |

### 3.2 순위 체크

| UC ID | Use Case | 액터 |
|-------|---------|------|
| UC-RANK-01 | 순위 체크 작업 요청 | Android Bot |
| UC-RANK-02 | 순위 체크 실행 | Android Bot |
| UC-RANK-03 | 순위 결과 보고 | Android Bot |
| UC-RANK-04 | 순위 이력 조회 | 운영자 |

### 3.3 봇 네트워크 관리

| UC ID | Use Case | 액터 |
|-------|---------|------|
| UC-BOT-01 | 봇 등록 | Android Bot |
| UC-BOT-02 | 봇 상태 업데이트 | Android Bot, Bot Agent |
| UC-BOT-03 | 오프라인 봇 복구 | Bot Agent |
| UC-BOT-04 | 봇 네트워크 모니터링 | 운영자, Bot Agent |

### 3.4 변수 최적화

| UC ID | Use Case | 액터 |
|-------|---------|------|
| UC-VAR-01 | 변수 조합 생성 | Variable Agent |
| UC-VAR-02 | A/B 테스트 실행 | Variable Agent |
| UC-VAR-03 | 변수 진화 (유전 알고리즘) | Variable Agent |
| UC-VAR-04 | 최적 변수 선택 | Variable Agent |

---

## 4. Use Case 상세

---

### UC-CAM-01: 캠페인 생성

**개요**
- **액터**: 운영자
- **목적**: 새로운 순위 모니터링 캠페인을 생성한다
- **선행 조건**: 운영자가 시스템에 로그인되어 있다
- **후행 조건**: 캠페인이 DB에 저장되고 대시보드에 표시된다

**기본 흐름**

```
1. 운영자가 대시보드에서 "캠페인 생성" 버튼을 클릭한다
2. 시스템이 캠페인 생성 폼을 표시한다
3. 운영자가 다음 정보를 입력한다:
   - 캠페인명
   - 키워드
   - 상품 ID (MID)
   - 플랫폼 (네이버/쿠팡)
   - 목표 순위
4. 운영자가 "생성" 버튼을 클릭한다
5. 시스템이 캠페인을 DB에 저장한다
6. 시스템이 성공 메시지를 표시한다
```

**대안 흐름**

```
3a. Zero API에서 키워드 목록 가져오기:
    1. 운영자가 "Zero API에서 가져오기" 버튼을 클릭한다
    2. 시스템이 Zero API에서 활성 키워드 목록을 조회한다
    3. 시스템이 키워드 선택 모달을 표시한다
    4. 운영자가 키워드를 선택한다
    5. 기본 흐름 4로 진행한다
```

**예외 흐름**

```
E1. 중복 캠페인:
    - 동일 키워드+상품ID 캠페인이 존재하면 경고 표시

E2. Zero API 연결 실패:
    - 에러 메시지 표시 및 수동 입력 안내
```

---

### UC-RANK-01: 순위 체크 작업 요청

**개요**
- **액터**: Android Bot
- **목적**: 서버로부터 순위 체크 작업을 요청받는다
- **선행 조건**: 봇이 등록되어 있고 온라인 상태이다
- **후행 조건**: 봇이 작업 정보를 받거나 대기 상태가 된다

**기본 흐름**

```
1. Android Bot이 getTask API를 호출한다
   - 파라미터: botId, loginId, imei
2. 서버가 활성 캠페인 중 작업이 필요한 것을 조회한다
3. 서버가 변수 조합을 선택한다 (Variable Agent 로직)
4. 서버가 RankCheckTask를 생성하여 반환한다:
   - taskId
   - keyword
   - productId
   - variables (userAgent, cookies, etc.)
5. Bot이 작업 정보를 수신한다
```

**대안 흐름**

```
2a. 사용 가능한 작업이 없음:
    1. 서버가 {success: false, message: "No tasks available"} 반환
    2. Bot이 60초 대기 후 재요청
```

**시퀀스 다이어그램**

```
Bot              Server              Database
 │                 │                    │
 ├─ getTask() ────>│                    │
 │                 ├─ SELECT campaign ──>│
 │                 │<── campaign data ───┤
 │                 │                    │
 │                 ├─ SELECT variables ─>│
 │                 │<── best combo ──────┤
 │                 │                    │
 │<─ RankCheckTask─┤                    │
 │                 │                    │
```

---

### UC-RANK-02: 순위 체크 실행

**개요**
- **액터**: Android Bot
- **목적**: 네이버 쇼핑에서 상품 순위를 체크한다
- **선행 조건**: 봇이 유효한 RankCheckTask를 보유하고 있다
- **후행 조건**: 순위가 확인되거나 "미발견" 결과가 생성된다

**기본 흐름**

```
1. Bot이 WebView를 초기화한다
   - User-Agent 설정
   - 쿠키 주입 (NNB, NID_AUT, NID_SES)
2. Bot이 네이버 쇼핑 검색 URL을 로드한다
   - URL: https://msearch.shopping.naver.com/search/all?query={keyword}
3. Bot이 페이지 로드 완료를 기다린다
4. Bot이 JavaScript를 실행하여 상품 목록을 추출한다
5. Bot이 productId와 매칭되는 상품을 찾는다
6. 매칭 성공 시:
   - 순위 = (page - 1) * 40 + index + 1
7. Bot이 순위 결과를 저장한다
```

**대안 흐름**

```
5a. 현재 페이지에서 상품 미발견:
    1. 총 상품 수 < 400 이면:
       - "더보기" 클릭 또는 다음 페이지 로드
       - 기본 흐름 3으로 돌아감
    2. 총 상품 수 >= 400 이면:
       - 순위 = -1 (미발견)
       - 기본 흐름 7로 진행
```

**예외 흐름**

```
E1. 페이지 로드 타임아웃:
    - 3회 재시도 후 실패 시 에러 보고

E2. IP 차단 감지 (403):
    - Bot Agent에 알림
    - 봇 상태를 "error"로 변경
```

---

### UC-VAR-03: 변수 진화 (유전 알고리즘)

**개요**
- **액터**: Variable Agent
- **목적**: 유전 알고리즘을 사용하여 최적의 변수 조합을 진화시킨다
- **선행 조건**: 이전 세대의 테스트 결과가 존재한다
- **후행 조건**: 새로운 세대의 변수 조합이 생성된다

**기본 흐름**

```
1. Variable Agent가 현재 세대의 성과 점수를 조회한다
2. Elite 선택 (상위 10% 조합 유지)
3. 교차(Crossover) 연산:
   - 상위 조합들의 변수를 교차하여 새 조합 생성
   - 40% 비율
4. 변이(Mutation) 연산:
   - 무작위로 일부 변수 값 변경
   - 40% 비율
5. 무작위 생성:
   - 완전 새로운 조합 추가
   - 10% 비율
6. 새 세대를 DB에 저장한다
7. 대시보드를 업데이트한다
```

**예시**

```
세대 5 → 세대 6 진화:
- 총 조합: 50개
- Elite: 5개 (상위 10%)
- Crossover: 20개 (40%)
- Mutation: 20개 (40%)
- Random: 5개 (10%)

성과 점수 변화: 7,500 → 8,200 (+9.3%)
```

---

### UC-BOT-03: 오프라인 봇 복구

**개요**
- **액터**: Bot Agent
- **목적**: 오프라인 상태의 봇을 감지하고 복구한다
- **선행 조건**: Bot Agent가 활성화되어 있다
- **후행 조건**: 봇이 온라인으로 복구되거나 알림이 발송된다

**기본 흐름**

```
1. Bot Agent가 주기적으로 봇 상태를 확인한다 (5분 간격)
2. last_seen_at이 10분 이상 지난 봇을 감지한다
3. 복구 시도:
   a. 봇에 재시작 명령 전송
   b. 30초 대기
   c. 상태 재확인
4. 복구 성공 시:
   - 봇 상태를 "online"으로 변경
   - 로그 기록
5. 복구 실패 시:
   - 3회까지 재시도
   - 실패 시 운영자에게 알림
```

**대안 흐름**

```
3a. IP 차단으로 인한 오프라인:
    1. 대장봇 재시작 요청
    2. IP 변경 확인
    3. 해당 봇들을 새 그룹에 재할당
```

---

## 5. Use Case 다이어그램

```
                           ┌─────────────────────────────────────┐
                           │           Turafic System            │
                           │                                     │
    ┌─────────┐           │  ┌─────────────────────────────┐   │
    │         │           │  │                             │   │
    │ 운영자  │──────────>│  │   캠페인 생성/관리          │   │
    │         │           │  │   (UC-CAM-01~04)            │   │
    └─────────┘           │  │                             │   │
                           │  └─────────────────────────────┘   │
                           │                                     │
                           │  ┌─────────────────────────────┐   │
    ┌─────────┐           │  │                             │   │
    │ Android │           │  │   순위 체크                 │   │
    │   Bot   │──────────>│  │   (UC-RANK-01~04)           │   │
    │         │           │  │                             │   │
    └─────────┘           │  └─────────────────────────────┘   │
                           │                                     │
                           │  ┌─────────────────────────────┐   │
    ┌─────────┐           │  │                             │   │
    │Variable │           │  │   변수 최적화               │   │
    │  Agent  │──────────>│  │   (UC-VAR-01~04)            │   │
    │         │           │  │                             │   │
    └─────────┘           │  └─────────────────────────────┘   │
                           │                                     │
                           │  ┌─────────────────────────────┐   │
    ┌─────────┐           │  │                             │   │
    │  Bot    │           │  │   봇 네트워크 관리          │   │
    │  Agent  │──────────>│  │   (UC-BOT-01~04)            │   │
    │         │           │  │                             │   │
    └─────────┘           │  └─────────────────────────────┘   │
                           │                                     │
                           └──────────────┬──────────────────────┘
                                          │
                                          ▼
                           ┌─────────────────────────────────────┐
                           │           Zero API                  │
                           │   (외부 키워드/순위 데이터)          │
                           └─────────────────────────────────────┘
```

---

## 6. 비기능적 요구사항

### 6.1 성능

| 지표 | 목표 |
|-----|------|
| 순위 체크 속도 | 10~20초/키워드 |
| 봇 처리량 | 100 작업/시간/봇 |
| API 응답 시간 | < 500ms |
| 봇 가용률 | > 95% |

### 6.2 가용성

- 24/7 무중단 운영
- 봇 장애 시 자동 복구
- 서버 장애 시 자동 재시작

### 6.3 보안

- 쿠키 암호화 저장
- API 토큰 인증
- HTTPS 통신
- IP 차단 회피 전략

---

## 7. 참고 문서

- [System Design](SYSTEM_DESIGN.md)
- [API Reference](api/RANK_CHECK_API.md)
- [Variable Mapping](VARIABLE_MAPPING.md)

---

**작성자**: Claude Code
**마지막 업데이트**: 2025-12-29
